import GithubFileReaderDisplay from "../../components/GithubFileReaderDisplay";

# Building EVM Event Listeners for Eigenlayer AVS

## Introduction

This will guide you through setting up and using EVM event listeners for Eigenlayer AVSes, using examples from the
[incredible squaring implementation](https://github.com/tangle-network/gadget/tree/main/blueprints/incredible-squaring-eigenlayer).

EVM event listeners are crucial for interacting with smart contracts on Ethereum-compatible networks.
In the context of Eigenlayer and the blueprint macro system, these listeners allow your Gadget to respond to specific
events emitted by Eigenlayer contracts.

## Setting Up EVM Event Listeners

### 1. Contract Definition

First, define the contract interface using the `sol!` and `load_abi!` macros. This generates Rust bindings for your smart contract.
import GithubFileReaderDisplay from "../../components/GithubFileReaderDisplay";

<GithubFileReaderDisplay 
  url="https://github.com/tangle-network/gadget/blob/main/blueprints/incredible-squaring-eigenlayer/src/lib.rs"
  fromLine={11}
  toLine={22}
  title="incredible-squaring-eigenlayer/src/lib.rs"
/>

### 2. Job Definition with Event Handler

Use the [`#[job]`](./blueprint-macros/jobs.mdx) macro to define a function that will handle specific events. Include the `event_listener` attribute to specify the event details:

<GithubFileReaderDisplay 
  url="https://github.com/tangle-network/gadget/blob/main/blueprints/incredible-squaring-eigenlayer/src/jobs/initialize_task.rs"
  fromLine={12}
  toLine={55}
  title="incredible-squaring-eigenlayer/src/jobs/initialize_task.rs"
/>

### 3. Event Converter Function

Implement a function to convert the event data into the format expected by your job function:

<GithubFileReaderDisplay 
  url="https://github.com/tangle-network/gadget/blob/main/blueprints/incredible-squaring-eigenlayer/src/jobs/initialize_task.rs"
  fromLine={57}
  toLine={68}
  title="incredible-squaring-eigenlayer/src/jobs/initialize_task.rs"
/>

## Implementing the Event Listener

### 1. Set Up the Provider

Create an HTTP provider to connect to the Ethereum network:

```rust
let http_provider = ProviderBuilder::new()
    .with_recommended_fillers()
    .wallet(wallet.clone())
    .on_http(self.env.http_rpc_endpoint.parse()?)
    .root()
    .clone()
    .boxed();
```

### 2. Create the Contract Instance

Instantiate the contract using the generated bindings:

```rust
let contract: IncredibleSquaringTaskManager::IncredibleSquaringTaskManagerInstance =
    IncredibleSquaringTaskManager::IncredibleSquaringTaskManagerInstance::new(contract_address, provider);
```

### 3. Set up the BlueprintRunner

Use the `EventWatcher` to listen for and handle events:

<GithubFileReaderDisplay 
  url="https://github.com/tangle-network/gadget/blob/main/blueprints/incredible-squaring-eigenlayer/src/main.rs"
  fromLine={89}
  toLine={96}
  title="incredible-squaring-eigenlayer/src/main.rs"
/>

## Best Practices and Considerations

1. **Error Handling**: Implement robust error handling in your event listener functions to manage potential failures gracefully.
2. **Asynchronous Operations**: Use `async/await` for operations that may take time, such as network requests or complex computations.
3. **Event Filtering**: Consider implementing additional filtering logic in your event converter function if you need to process only specific events based on certain criteria.
4. **State Management**: If your Gadget needs to maintain state between events, consider implementing a state management system.
5. **Testing**: Implement unit tests for your event handling logic, including the event converter function.
6. **Logging**: Use appropriate logging to track the event handling process and aid in debugging.
7. **Gas Considerations**: Be aware of the gas costs associated with your on-chain interactions, especially when responding to events with transactions.
8. **Scalability**: Design your event handling system to scale with the number of events you expect to process.
